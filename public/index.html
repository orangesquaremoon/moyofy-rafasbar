<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>MOYOFY ¬∑ Rafa's Bar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff004c;
      --primary-dark: #cc003d;
      --dark: #1a1a2e;
      --darker: #12121f;
      --light: #f8f9fa;
      --gray: #6c757d;
      --success: #00ffaa;
      --warning: #ffcc00;
      --danger: #ff6b6b;
      --purple: #9d4edd;
      --blue: #4361ee;
      --pink: #ff006e;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    body {
      color: white;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, var(--darker) 0%, #2d2d4f 100%);
      overflow-x: hidden;
    }

    .container { max-width: 900px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
    header { text-align:center; margin-bottom: 25px; animation: fadeInDown .5s ease; }
    @keyframes fadeInDown { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }

    h1 {
      font-size: 3.3rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ff004c, #ff7300, #9d4edd, #4361ee);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(255, 0, 76, 0.3);
      position: relative;
      animation: gradientShift 5s ease infinite;
    }
    @keyframes gradientShift { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    h1::after { content:''; position:absolute; bottom:-10px; left:50%; transform:translateX(-50%); width:60px; height:4px; background:var(--primary); border-radius:2px; }
    h2 { font-size: 1.05rem; color:#aaa; margin-bottom: 5px; }
    .submeta { color:#8f8fb3; font-size:.92rem; margin-top: 5px; }

    .card {
      background: rgba(30, 30, 50, 0.9);
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 0, 76, 0.25);
      border-radius: 20px;
      padding: 22px;
      margin-bottom: 18px;
      transition: all .25s ease;
      box-shadow: 0 10px 30px rgba(255, 0, 76, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.08);
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(255, 0, 76, 0.2), inset 0 1px 0 rgba(255,255,255,.08); }

    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex: 1; min-width: 220px; }
    .small { font-size:.9rem; color:#b8b8d7; }

    .search-box {
      background: rgba(25, 25, 40, 0.95);
      border: 2px solid rgba(255,0,76,.55);
      border-radius: 20px;
      padding: 22px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.65), inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .search-input {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 15px;
      background: rgba(40, 40, 60, 0.9);
      color: white;
      font-size: 1.05rem;
      border: 2px solid transparent;
      transition: all .2s ease;
      box-shadow: inset 0 2px 5px rgba(0,0,0,.45);
    }
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(255,0,76,.25), inset 0 2px 5px rgba(0,0,0,.45);
    }
    .search-input::placeholder { color:#888; }

    .btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(45deg, var(--primary), var(--pink));
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 1.05rem;
      font-weight: 800;
      cursor: pointer;
      transition: all .2s ease;
      display:flex; align-items:center; justify-content:center; gap:10px;
      box-shadow: 0 6px 20px rgba(255,0,76,.35);
      position: relative;
      overflow: hidden;
      user-select: none;
    }
    .btn::after {
      content:'';
      position:absolute;
      top:0; left:-100%;
      width:100%; height:100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left .65s ease;
    }
    .btn:hover::after { left: 100%; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(255,0,76,.55); }
    .btn:active { transform: translateY(0) scale(.99); }
    .btn.secondary { background: transparent; border: 2px solid rgba(0,255,170,.45); color: var(--success); box-shadow:none; }
    .btn.secondary:hover { background: rgba(0,255,170,.07); box-shadow: 0 10px 25px rgba(0,255,170,.15); }
    .btn.ghost { background: transparent; border: 2px solid rgba(255,0,76,.45); color: var(--primary); box-shadow:none; }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: .92rem;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
    }
    .pill.success { color: var(--success); border-color: rgba(0,255,170,.25); background: rgba(0,255,170,.06); }
    .pill.warning { color: var(--warning); border-color: rgba(255,204,0,.25); background: rgba(255,204,0,.06); }
    .pill.danger { color: var(--danger); border-color: rgba(255,107,107,.25); background: rgba(255,107,107,.06); }

    .user-panel { text-align:center; }
    .points-display {
      font-size: 2.7rem;
      font-weight: 900;
      color: var(--success);
      margin: 8px 0 6px;
      text-shadow: 0 0 14px rgba(0,255,170,.55);
      background: linear-gradient(45deg, var(--success), #00cc88, #00ffaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }
    @keyframes pulseGlow { 0%{text-shadow:0 0 10px rgba(0,255,170,.4)} 100%{text-shadow:0 0 20px rgba(0,255,170,.75), 0 0 30px rgba(0,255,170,.35)} }
    .level-badge {
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: linear-gradient(45deg, var(--primary), var(--purple));
      color: white;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: .98rem;
      font-weight: 900;
      box-shadow: 0 4px 15px rgba(157,78,221,.35);
      animation: badgeFloat 3s ease-in-out infinite;
    }
    @keyframes badgeFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }

    .message {
      padding: 16px;
      border-radius: 12px;
      margin: 14px 0 0;
      text-align: center;
      font-weight: 900;
      backdrop-filter: blur(10px);
      border: 2px solid transparent;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
      animation: messageAppear .4s ease;
    }
    @keyframes messageAppear { 0%{opacity:0; transform:translateY(-10px) scale(.96)} 100%{opacity:1; transform:translateY(0) scale(1)} }
    .message.success { background: rgba(0,255,170,.18); border-color: rgba(0,255,170,.35); color: var(--success); }
    .message.error { background: rgba(255,107,107,.18); border-color: rgba(255,107,107,.35); color: var(--danger); }
    .message.warning { background: rgba(255,204,0,.18); border-color: rgba(255,204,0,.35); color: var(--warning); }

    .results-container { margin-top: 14px; }
    .loading { text-align:center; padding: 26px 10px; color: var(--gray); }
    .spinner {
      border: 4px solid rgba(255,255,255,0.10);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 46px; height: 46px;
      animation: spin 1s linear infinite;
      margin: 0 auto 14px;
    }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .song-item {
      background: rgba(35, 35, 55, 0.9);
      border-left: 5px solid var(--primary);
      padding: 16px;
      margin: 12px 0;
      border-radius: 12px;
      transition: all .22s ease;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,.25);
      position: relative;
      overflow: hidden;
    }
    .song-item:hover {
      background: rgba(45,45,70,.95);
      transform: translateX(6px) scale(1.01);
      border-left-color: var(--success);
      box-shadow: 0 8px 22px rgba(0,255,170,.22);
    }
    .song-info { flex:1; min-width: 0; }
    .song-title { font-weight: 900; font-size: 1.05rem; margin-bottom: 4px; color: var(--light); }
    .song-artist { color:#aaa; font-size: .9rem; }
    .song-duration {
      font-size: .8rem;
      color: var(--gray);
      background: rgba(255,255,255,0.05);
      padding: 3px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      display:inline-block;
      margin-top: 6px;
    }
    .song-duration.warning { color: var(--warning); background: rgba(255,204,0,0.08); border-color: rgba(255,204,0,0.18); }
    .song-duration.too-long { color: var(--danger); background: rgba(255,107,107,0.08); border-color: rgba(255,107,107,0.18); text-decoration: line-through; }

    .add-btn {
      background: linear-gradient(45deg, var(--success), #00cc88);
      color: #08110c;
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 900;
      cursor: pointer;
      transition: all .2s ease;
      min-width: 130px;
      box-shadow: 0 4px 14px rgba(0,255,170,.28);
      user-select: none;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .add-btn:hover { transform: scale(1.05); box-shadow: 0 6px 18px rgba(0,255,170,.44); }
    .add-btn:disabled { opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; background: linear-gradient(45deg, #6d6d6d, #858585); color:#1c1c1c; }
    
    /* ‚úÖ AJUSTE 3: pointer-events:none para √≠conos dentro de botones */
    .add-btn i,
    .btn i,
    .vote-btn i {
      pointer-events: none;
    }

    .vote-btn {
      background: transparent;
      border: none;
      color: #cfcfff;
      cursor: pointer;
      font-weight: 900;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all .2s ease;
      font-size: 0.85rem;
    }
    .vote-btn:hover {
      background: rgba(0, 255, 170, 0.1);
      color: var(--success);
    }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .tile {
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .tile .k { color:#a9a9c9; font-size:.82rem; font-weight:800; }
    .tile .v { font-size: 1.35rem; font-weight: 950; color: var(--success); margin-top: 6px; }
    .tile .v.smallv { font-size: 1.05rem; color: #eaeaff; font-weight: 900; }

    .progress-container {
      background: rgba(40, 40, 60, 0.8);
      border-radius: 15px;
      padding: 14px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .progress-header { display:flex; justify-content:space-between; margin-bottom: 10px; font-size: .9rem; color:#aaa; }
    .progress-bar { height: 14px; background: rgba(0,0,0,0.25); border-radius: 10px; overflow:hidden; border: 2px solid rgba(255,255,255,0.08); }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff004c, #ff7300, #00ffaa);
      border-radius: 8px;
      transition: width .8s ease-in-out;
      min-width: 6px;
    }
    .xp-display { display:flex; justify-content:space-between; margin-top: 8px; font-size: .85rem; color:#888; }

    .divider { height:1px; width:100%; background: rgba(255,255,255,0.10); margin: 14px 0; }

    .auth-required {
      background: rgba(255, 69, 58, 0.18);
      border: 2px solid rgba(255, 69, 58, 0.35);
      color: var(--danger);
      cursor: pointer;
      transition: all .2s ease;
      padding: 16px;
      border-radius: 12px;
      margin-top: 14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(255,69,58,.18);
      text-align: left;
      font-weight: 900;
    }
    .auth-required:hover { background: rgba(255,69,58,0.26); transform: scale(1.01); }

    .intro-screen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4f 100%);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index: 10000;
      transition: opacity .7s ease;
      padding: 20px;
    }
    .intro-title {
      font-size: 4.2rem;
      font-weight: 950;
      background: linear-gradient(45deg, #ff004c, #ff7300, #00ffaa, #4361ee);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 3s ease infinite, titlePulse 2s ease-in-out infinite;
      text-align:center;
      margin-bottom: 14px;
    }
    @keyframes titlePulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    .intro-subtitle { font-size: 1.15rem; color:#aaa; margin-bottom: 26px; text-align:center; max-width: 650px; line-height:1.35; }
    .start-button {
      background: linear-gradient(45deg, #ff004c, #ff7300);
      color: white;
      border: none;
      padding: 18px 44px;
      font-size: 1.15rem;
      font-weight: 950;
      border-radius: 999px;
      cursor: pointer;
      transition: all .2s ease;
      box-shadow: 0 10px 30px rgba(255, 0, 76, 0.35);
      position: relative;
      overflow: hidden;
      user-select: none;
      display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .start-button:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 15px 40px rgba(255,0,76,.55); }
    .start-button:active { transform: translateY(0) scale(.99); }

    .sound-toggle {
      position: fixed;
      bottom: 18px; right: 18px;
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,0,76,0.55);
      border-radius: 50%;
      width: 50px; height: 50px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      z-index: 120;
      transition: all .2s ease;
      user-select: none;
    }
    .sound-toggle:hover { background: rgba(255,0,76,0.16); transform: scale(1.08); }
    .sound-toggle i { font-size: 1.35rem; color: var(--primary); }

    .confetti-container { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 9999; overflow:hidden; }
    .confetti { position: absolute; width: 14px; height: 14px; background: var(--primary); top:0; opacity:0; }
    @keyframes confetti-explosion {
      0% { opacity: 1; transform: translate(0,0) rotate(0deg) scale(0); }
      10% { opacity: 1; transform: translate(var(--tx), var(--ty)) rotate(var(--r)) scale(1); }
      100% { opacity: 0; transform: translate(calc(var(--tx) * 1.5), calc(var(--ty) * 1.5 + 100vh)) rotate(calc(var(--r) * 3)) scale(0); }
    }

    .points-animation {
      position: fixed;
      color: #00ffaa;
      font-weight: 950;
      font-size: 1.65rem;
      text-shadow: 0 0 10px rgba(0,255,170,.75);
      z-index: 10001;
      pointer-events: none;
      animation: pointsFloat 2.3s ease-out forwards;
    }
    @keyframes pointsFloat {
      0% { opacity: 1; transform: translate(0,0) scale(.9); }
      25% { opacity: 1; transform: translate(0,-50px) scale(1.35); }
      60% { opacity: 1; transform: translate(0,-140px) scale(1.05); }
      100% { opacity: 0; transform: translate(0,-200px) scale(.6); }
    }

    .level-up-animation {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 4.6rem;
      font-weight: 950;
      color: #00ffaa;
      text-shadow: 0 0 30px rgba(0,255,170,.75);
      z-index: 10001;
      pointer-events: none;
      animation: levelUpPop 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-align:center;
    }
    @keyframes levelUpPop {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.35); opacity: 1; }
      40% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      70% { transform: translate(-50%, -50%) scale(1.12) rotate(3deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.22); opacity: 0; }
    }

    footer { text-align:center; margin-top: 28px; color:#8b8bb3; font-size:.9rem; padding: 18px; border-top: 1px solid rgba(255,255,255,0.10); }

    @media (max-width: 768px) {
      body { padding: 14px; }
      .container { padding: 10px; }
      h1 { font-size: 2.6rem; }
      .intro-title { font-size: 3.2rem; }
      .grid3 { grid-template-columns: 1fr; }
      .grid2 { grid-template-columns: 1fr; }
      .add-btn { min-width: 120px; }
    }
  </style>
</head>

<body>
  <div class="intro-screen" id="intro-screen">
    <h1 class="intro-title">üé∏ MOYOFY</h1>
    <p class="intro-subtitle">
      Conecta con la m√∫sica. Conecta con la gente.<br>
      Tu vibra tiene valor ¬∑ Rafa's Bar
    </p>
    <button class="start-button" id="btn-start">
      <i class="fas fa-play"></i> ENTRAR AL BAR
    </button>
    <div style="margin-top: 28px; color: #777; text-align: center; max-width: 720px;">
      <div class="row" style="justify-content:center; margin-bottom: 10px;">
        <span class="pill warning"><i class="fas fa-clock"></i> L√≠mite: 7 min</span>
        <span class="pill success"><i class="fas fa-shield"></i> MusicDefend</span>
        <span class="pill"><i class="fas fa-bolt"></i> Ranking en vivo</span>
      </div>
      <p style="font-size:.95rem; line-height:1.4;">
        No necesit√°s descargar apps. Entr√°s por QR. Suger√≠s canciones. Gan√°s MOYOS. Sub√≠s de nivel. Envi√°s regalos.
      </p>
    </div>
  </div>

  <div class="sound-toggle" id="sound-toggle" title="Sonido">
    <i class="fas fa-volume-up" id="sound-icon"></i>
  </div>

  <div class="container" id="main-container" style="display:none;">
    <header>
      <h1>üé∏ MOYOFY</h1>
      <h2>Tu vibra tiene valor ¬∑ Rafa's Bar</h2>
      <div class="submeta" id="connection-pill">
        <span class="pill" id="pill-conn"><i class="fas fa-wifi"></i> Conectando...</span>
      </div>
    </header>

    <div class="card user-panel">
      <div id="onboarding" style="display:none;">
        <h3 style="font-weight:950; margin-bottom: 10px;">üë§ Entr√° con tu apodo</h3>
        <div class="grid2" style="margin-top: 12px;">
          <div class="tile">
            <div class="k">Apodo (para ranking)</div>
            <input type="text" id="nickname" placeholder="Ej: RockMaster69" class="search-input" autocomplete="off" maxlength="24">
            <div class="small" style="margin-top:8px;"><i class="fas fa-info-circle"></i> No uses tu nombre real si no quer√©s.</div>
          </div>
          <div class="tile">
            <div class="k">Correo (opcional)</div>
            <input type="email" id="email" placeholder="Ej: correo@dominio.com" class="search-input" autocomplete="email" maxlength="80">
            <div class="small" style="margin-top:8px;"><i class="fas fa-lock"></i> Sirve para recuperar tu perfil en el futuro.</div>
          </div>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button class="btn grow" id="btn-enter">
            <i class="fas fa-sign-in-alt"></i> ENTRAR
          </button>
          <button class="btn secondary grow" id="btn-guest">
            <i class="fas fa-user-ninja"></i> ENTRAR COMO INVITADO
          </button>
        </div>
        <div id="message-onboarding"></div>
      </div>

      <div id="profile" style="display:none;">
        <div class="row" style="justify-content:space-between;">
          <div style="text-align:left;">
            <div style="font-weight:950; font-size: 1.15rem;">
              ¬°Bienvenido, <span id="user-nickname">usuario</span>!
            </div>
            <div class="small" id="user-handle" style="margin-top:6px;">
              <i class="fas fa-id-badge"></i> <span id="user-id">‚Äî</span>
              <span style="margin:0 8px;">‚Ä¢</span>
              <i class="fas fa-clock"></i> <span id="user-streak">‚Äî</span>
            </div>
          </div>
          <div style="text-align:right;">
            <span class="pill success" id="pill-live"><i class="fas fa-bolt"></i> LIVE</span>
          </div>
        </div>

        <div class="points-display">
          <i class="fas fa-coins"></i> <span id="user-points">100</span> MOYOS
        </div>

        <div class="row" style="justify-content:center; margin-bottom: 8px;">
          <span class="level-badge"><i class="fas fa-level-up-alt"></i> Nivel <span id="user-level">1</span></span>
          <span class="pill"><i class="fas fa-music"></i> <span id="songs-added">0</span> canciones</span>
          <span class="pill"><i class="fas fa-thumbs-up"></i> <span id="votes-received">0</span> votos</span>
        </div>

        <div class="progress-container">
          <div class="progress-header">
            <span id="current-level-display">Nivel 1</span>
            <span id="next-level-display">Nivel 2</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="level-progress-fill" style="width:0%"></div>
          </div>
          <div class="xp-display">
            <span id="current-xp-display">0/100 XP</span>
            <span id="xp-to-next">100 XP para subir</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid3">
          <div class="tile">
            <div class="k">Ranking (Top)</div>
            <div class="v smallv" id="top1">‚Äî</div>
            <div class="small" id="top2">‚Äî</div>
            <div class="small" id="top3">‚Äî</div>
          </div>

          <div class="tile">
            <div class="k">Regalos</div>
            <div class="v" id="gift-count">0</div>
            <div class="small">Enviados hoy</div>
          </div>

          <div class="tile">
            <div class="k">Modo</div>
            <div class="v smallv" id="priority-mode">Normal</div>
            <div class="small">Sub√≠ prioridad con MOYOS</div>
          </div>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button class="btn ghost grow" id="btn-change">
            <i class="fas fa-user-edit"></i> Cambiar apodo
          </button>
          <button class="btn secondary grow" id="btn-refresh">
            <i class="fas fa-sync"></i> Sincronizar
          </button>
        </div>

        <div id="message-profile"></div>
      </div>
    </div>

    <div class="search-box">
      <div class="row" style="justify-content:space-between; margin-bottom: 10px;">
        <div style="font-weight:950; font-size: 1.1rem;">üéµ Buscar canci√≥n</div>
        <div class="row" style="gap:10px;">
          <span class="pill warning" title="M√°ximo 7 minutos por canci√≥n"><i class="fas fa-clock"></i> 7 min</span>
          <span class="pill success" title="Filtro Rock/Metal/Alternativo"><i class="fas fa-filter"></i> MusicDefend</span>
        </div>
      </div>

      <div class="small" style="line-height:1.35;">
        Suger√≠ canciones con vibra rock/metal/alternativo. Gan√°s MOYOS por sugerencia v√°lida.
        <span style="display:block; margin-top:4px;">
          <i class="fas fa-keyboard"></i> Tip: presion√° <b>Enter</b> para buscar.
        </span>
      </div>

      <div style="margin-top: 12px;">
        <input type="text" id="song-search" placeholder="Busca tu canci√≥n favorita..." class="search-input" autocomplete="off" />
      </div>

      <div style="margin-top: 12px;">
        <button class="btn" id="btn-search">
          <i class="fas fa-search"></i> BUSCAR CANCIONES
        </button>
      </div>

      <div id="auth-required-message" style="display:none;" class="auth-required">
        <i class="fas fa-lock"></i> <strong>üîê Necesit√°s autorizar YouTube</strong><br>
        Para agregar canciones a la playlist, autoriz√° MOYOFY con tu cuenta de Google.<br>
        <small>(Solo una vez por sesi√≥n)</small>
      </div>

      <div id="message-container"></div>

      <div class="results-container" id="results-container">
        <div class="loading">
          <div class="spinner"></div>
          <p>¬øQu√© canci√≥n quer√©s agregar hoy?</p>
          <p class="small" style="margin-top:8px;">Entr√° con tu apodo para aparecer en ranking en vivo.</p>
        </div>
      </div>

      <div class="divider"></div>

      <div class="card" style="margin:0; border-color: rgba(0,255,170,.22); background: rgba(15,15,30,.45);">
        <div class="row" style="justify-content:space-between;">
          <div style="font-weight:950;"><i class="fas fa-gift"></i> Regalos virtuales</div>
          <span class="pill success"><i class="fas fa-bolt"></i> LIVE</span>
        </div>
        <div class="small" style="margin-top: 8px; line-height:1.35;">
          Envi√° MOYOS a otros usuarios (individuos). Esto activa animaciones y suma al ranking.
        </div>

        <div class="grid2" style="margin-top: 12px;">
          <div class="tile">
            <div class="k">Enviar a (apodo)</div>
            <input type="text" id="gift-to" placeholder="Ej: MetallicaFan" class="search-input" autocomplete="off" maxlength="24">
          </div>
          <div class="tile">
            <div class="k">Regalo</div>
            <select id="gift-type" class="search-input" style="appearance:none;">
              <option value="beer">üç∫ Cerveza dorada (+10)</option>
              <option value="shot">üî• Shot infernal (+25)</option>
              <option value="crown">üëë Corona neon (+50)</option>
              <option value="unicorn">ü¶Ñ Unicornio neon (+80)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button class="btn secondary grow" id="btn-send-gift">
            <i class="fas fa-paper-plane"></i> ENVIAR REGALO
          </button>
          <button class="btn ghost grow" id="btn-open-leaderboard">
            <i class="fas fa-trophy"></i> VER RANKING
          </button>
        </div>

        <div id="message-gifts"></div>
      </div>
    </div>

    <footer>
      <p>MOYOFY ¬∑ Social Music Bar Platform ¬∑ ¬© 2025 Abundia.io</p>
      <p class="small">M√∫sica v√≠a YouTube ¬∑ L√≠mite 7 min ¬∑ Econom√≠a interna (MOYOS) ¬∑ Ranking en vivo</p>
    </footer>
  </div>

  <div class="confetti-container" id="confetti-container"></div>

  <audio id="success-sound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg"></audio>
  <audio id="level-up-sound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-trumpet-2018.mp3" type="audio/mpeg"></audio>
  <audio id="click-sound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg"></audio>
  <audio id="explosion-sound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-fireworks-explosion-3038.mp3" type="audio/mpeg"></audio>

  <!-- SDK Supabase (define window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const BAR_LOCATION = { lat: 9.93422, lng: -84.06894 };
    const RADIUS_METERS = 20000;

    // ‚úÖ MODIFICACI√ìN: desactivar completamente el uso de geolocalizaci√≥n
    const GEOLOCATION_REQUIRED = false;

    const COOLDOWN_MS = 5 * 60 * 1000;
    const MAX_DURATION_MINUTES = 7;
    const MAX_DURATION_SECONDS = MAX_DURATION_MINUTES * 60;

    let soundEnabled = true;
    let currentUser = null;
    let API_BASE = window.location.origin;
    let requiresAuth = false;
    let lastLevel = 1;

    let SUPABASE_URL = null;
    let SUPABASE_ANON_KEY = null;
    let BAR_ID = "rafasbar";

    // IMPORTANTE: NO declarar "supabase" aqu√≠ (ya existe por CDN).
    let sbClient = null;
    let realtimeChannel = null;

    const ECONOMY = {
      baseGiftValues: { beer: 10, shot: 25, crown: 50, unicorn: 80 },
      pointsPerSong: 10,
      xpPerLevel: 100,
      voteReward: 3,
      giftSendCostMultiplier: 1
    };

    function $(id){ return document.getElementById(id); }

    // ‚úÖ NUEVA FUNCI√ìN: resolveButtonEl - Normaliza el elemento para obtener siempre el bot√≥n
    function resolveButtonEl(el) {
      if (!el) return null;
      if (el.tagName === 'BUTTON') return el;
      return el.querySelector ? el.querySelector('button') : null;
    }

    // ‚úÖ FUNCI√ìN MEJORADA: escapeHtml - Escapa todos los caracteres HTML
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    // ‚úÖ AJUSTE 1: escapeForAttribute CORREGIDO - HTML escape para atributos
    function escapeForAttribute(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // ‚úÖ NUEVA FUNCI√ìN: safeJSON - Convierte a JSON seguro para atributos data
    function safeJSON(obj) {
      return JSON.stringify(obj || {}).replace(/</g, '\\u003c');
    }

    function playSound(soundId) {
      if (!soundEnabled) return;
      const sound = document.getElementById(soundId);
      if (!sound) return;
      try { sound.currentTime = 0; sound.play(); } catch (e) {}
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const icon = $('sound-icon');
      icon.className = soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
      if (soundEnabled) playSound('click-sound');
    }

    function formatDuration(seconds) {
      if (!seconds && seconds !== 0) return '--:--';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function parseISODuration(duration) {
      if (!duration) return 0;
      const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const hours = parseInt(match[1] || '0', 10);
      const minutes = parseInt(match[2] || '0', 10);
      const seconds = parseInt(match[3] || '0', 10);
      return hours * 3600 + minutes * 60 + seconds;
    }

    function createEpicConfettiExplosion(x, y, intensity = 100) {
      playSound('explosion-sound');
      const container = $('confetti-container');
      for (let i = 0; i < intensity; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        const size = Math.random() * 18 + 8;
        confetti.style.width = `${size}px`;
        confetti.style.height = `${size}px`;
        confetti.style.left = `${x}px`;
        confetti.style.top = `${y}px`;
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        const palette = ['#ff004c','#00ffaa','#ffcc00','#9d4edd','#4361ee','#ff006e','#00ccff','#ff9900','#aa00ff','#00ff88'];
        confetti.style.background = palette[Math.floor(Math.random()*palette.length)];
        const tx = (Math.random() - 0.5) * 1100;
        const ty = (Math.random() - 0.5) * 950;
        const r = Math.random() * 720;
        confetti.style.setProperty('--tx', `${tx}px`);
        confetti.style.setProperty('--ty', `${ty}px`);
        confetti.style.setProperty('--r', `${r}deg`);
        confetti.style.animation = `confetti-explosion ${Math.random() * 2600 + 3800}ms ease-out forwards`;
        confetti.style.animationDelay = `${Math.random() * 420}ms`;
        container.appendChild(confetti);
        setTimeout(() => confetti.remove(), 7200);
      }
    }

    function createPointsAnimation(x, y, points, label = "MOYOS") {
      const container = $('confetti-container');
      const el = document.createElement('div');
      el.className = 'points-animation';
      el.textContent = `+${points} ${label}`;
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;
      container.appendChild(el);
      setTimeout(() => el.remove(), 2400);
    }

    function calculateLevel(points) {
      const level = Math.floor(points / ECONOMY.xpPerLevel) + 1;
      const currentXp = points % ECONOMY.xpPerLevel;
      const xpPercentage = (currentXp / ECONOMY.xpPerLevel) * 100;
      const xpNeeded = ECONOMY.xpPerLevel - currentXp;
      return { level, currentXp, xpPercentage, xpNeeded, nextLevel: level + 1 };
    }

    function showMessage(containerId, text, type='info') {
      const container = $(containerId);
      if (!container) return;
      let icon = 'info-circle';
      if (type === 'success') icon = 'check-circle';
      else if (type === 'error') icon = 'exclamation-circle';
      else if (type === 'warning') icon = 'exclamation-triangle';
      container.innerHTML = `<div class="message ${type}"><i class="fas fa-${icon}"></i> ${escapeHtml(text)}</div>`;
      setTimeout(() => { if (container) container.innerHTML = ''; }, 5200);
    }

    function setConnPill(ok, label) {
      const pill = $('pill-conn');
      if (!pill) return;
      const cls = ok ? 'pill success' : 'pill warning';
      pill.className = cls;
      pill.innerHTML = ok ? `<i class="fas fa-cloud"></i> ${escapeHtml(label)}` : `<i class="fas fa-triangle-exclamation"></i> ${escapeHtml(label)}`;
    }

    function todayKey() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function safeTrim(s){ return (s || '').toString().trim(); }

    function normalizeNickname(nick){
      return safeTrim(nick).replace(/\s+/g,' ').slice(0,24);
    }

    function setUIStateLoggedOut() {
      $('onboarding').style.display = 'block';
      $('profile').style.display = 'none';
    }

    function setUIStateLoggedIn() {
      $('onboarding').style.display = 'none';
      $('profile').style.display = 'block';
    }

    function updateProfileUI() {
      if (!currentUser) return;

      $('user-nickname').textContent = currentUser.nickname || 'usuario';
      $('user-id').textContent = currentUser.public_id || '‚Äî';
      $('user-points').textContent = currentUser.points ?? 100;

      const stats = calculateLevel(currentUser.points ?? 100);
      $('user-level').textContent = stats.level;
      $('current-level-display').textContent = `Nivel ${stats.level}`;
      $('next-level-display').textContent = `Nivel ${stats.nextLevel}`;
      $('level-progress-fill').style.width = `${stats.xpPercentage}%`;
      $('current-xp-display').textContent = `${stats.currentXp}/${ECONOMY.xpPerLevel} XP`;
      $('xp-to-next').textContent = `${stats.xpNeeded} XP para subir`;

      $('songs-added').textContent = currentUser.songs_added ?? 0;
      $('votes-received').textContent = currentUser.votes_received ?? 0;

      const streakLabel = currentUser.streak_days ? `${currentUser.streak_days} d√≠a(s)` : '0 d√≠a(s)';
      $('user-streak').textContent = `Racha: ${streakLabel}`;

      if (stats.level > lastLevel) {
        triggerLevelUpAnimation(stats.level);
        lastLevel = stats.level;
      }
    }

    function triggerLevelUpAnimation(level) {
      playSound('level-up-sound');
      const levelUp = document.createElement('div');
      levelUp.className = 'level-up-animation';
      levelUp.textContent = `üéâ NIVEL ${level}!`;
      document.body.appendChild(levelUp);
      createEpicConfettiExplosion(window.innerWidth/2, window.innerHeight/2, 180);
      setTimeout(() => levelUp.remove(), 2000);
    }

    async function requestLocation() {
      if (!navigator.geolocation) throw new Error('Geolocalizaci√≥n no soportada.');

      const getPos = (opts) => new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve(pos.coords),
          (err) => reject(err),
          opts
        );
      });

      // Intento 1: alta precisi√≥n (algunos dispositivos fallan aqu√≠)
      try {
        return await getPos({ enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
      } catch (e1) {
        // Intento 2: precisi√≥n normal + m√°s tolerancia
        try {
          return await getPos({ enableHighAccuracy: false, timeout: 25000, maximumAge: 60000 });
        } catch (e2) {
          // Mensaje claro seg√∫n error real
          const code = e2 && typeof e2.code !== 'undefined' ? e2.code : null;
          if (code === 1) throw new Error('Permiso de ubicaci√≥n denegado en el navegador.');
          if (code === 2) throw new Error('Ubicaci√≥n no disponible (GPS/WiFi). Activ√° ubicaci√≥n y "Precise location".');
          if (code === 3) throw new Error('Tiempo de espera de ubicaci√≥n. Reintent√° con mejor se√±al.');
          throw new Error('No se pudo obtener la ubicaci√≥n.');
        }
      }
    }

    function isUserNearBar(userLat, userLng) {
      const toRadians = (degrees) => degrees * Math.PI / 180;
      const R = 6371000;
      const barLat = BAR_LOCATION.lat;
      const barLng = BAR_LOCATION.lng;
      const dLat = toRadians(userLat - barLat);
      const dLng = toRadians(userLng - barLng);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRadians(barLat)) * Math.cos(toRadians(userLat)) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c;
      return distance <= RADIUS_METERS;
    }

    function canAddSong() {
      const lastAddTime = localStorage.getItem('moyofy_last_add');
      if (!lastAddTime) return true;
      return (Date.now() - parseInt(lastAddTime, 10)) >= COOLDOWN_MS;
    }

    function setLastAddTime() {
      localStorage.setItem('moyofy_last_add', Date.now().toString());
    }

    function showAuthRequiredMessage() {
      $('auth-required-message').style.display = 'block';
      $('auth-required-message').onclick = () => redirectToAuth();
    }

    function redirectToAuth() {
      window.location.href = `${API_BASE}/auth`;
    }

    function setResultsLoading(query) {
      $('results-container').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Buscando canciones...</p>
          <p class="small" style="margin-top:8px;"><b>${escapeHtml(query)}</b></p>
          <p class="small" style="margin-top:6px;"><i class="fas fa-clock"></i> Solo canciones de hasta ${MAX_DURATION_MINUTES} minutos</p>
        </div>
      `;
    }

    async function fetchPublicConfig() {
      try {
        const r = await fetch(`${API_BASE}/v2/public-config`, { method:'GET' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || 'Config inv√°lida');

        SUPABASE_URL = data.supabaseUrl;
        SUPABASE_ANON_KEY = data.supabaseAnonKey;
        BAR_ID = data.barId || BAR_ID;

        if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase && typeof window.supabase.createClient === 'function') {
          sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: { persistSession: false, autoRefreshToken: false },
            realtime: { params: { eventsPerSecond: 5 } }
          });
          setConnPill(true, 'Conectado');
          return true;
        }

        setConnPill(false, 'Modo local');
        return false;
      } catch (e) {
        setConnPill(false, 'Sin conexi√≥n');
        return false;
      }
    }

    function loadLocalUser() {
      try {
        const raw = localStorage.getItem('moyofy_user_v2');
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (_) { return null; }
    }

    function saveLocalUser(u) {
      localStorage.setItem('moyofy_user_v2', JSON.stringify(u));
    }

    function clearLocalUser() {
      localStorage.removeItem('moyofy_user_v2');
      localStorage.removeItem('moyofy_last_add');
    }

    async function bootstrapUser({ nickname, email, guest=false }) {
      const payload = { nickname, email, guest, barId: BAR_ID, clientTs: new Date().toISOString() };
      const r = await fetch(`${API_BASE}/v2/bootstrap`, {
        method:'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'No se pudo crear perfil');
      return data.user;
    }

    async function fetchMe(publicId) {
      const r = await fetch(`${API_BASE}/v2/me?publicId=${encodeURIComponent(publicId)}&barId=${encodeURIComponent(BAR_ID)}`);
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'No se pudo cargar perfil');
      return data.user;
    }

    async function fetchLeaderboard() {
      const r = await fetch(`${API_BASE}/v2/leaderboard?barId=${encodeURIComponent(BAR_ID)}&limit=10`);
      const data = await r.json();
      if (!data.ok) throw new Error(data.error || 'No se pudo cargar ranking');
      return data.items || [];
    }

    function renderTop3(items) {
      const a = items || [];
      $('top1').textContent = a[0] ? `#1 ${a[0].nickname} ¬∑ ${a[0].points} MOYOS` : '‚Äî';
      $('top2').textContent = a[1] ? `#2 ${a[1].nickname} ¬∑ ${a[1].points} MOYOS` : '‚Äî';
      $('top3').textContent = a[2] ? `#3 ${a[2].nickname} ¬∑ ${a[2].points} MOYOS` : '‚Äî';
    }

    async function syncAll() {
      if (!currentUser?.public_id) return;
      try {
        const fresh = await fetchMe(currentUser.public_id);
        currentUser = fresh;
        saveLocalUser(currentUser);
        updateProfileUI();
        const top = await fetchLeaderboard();
        renderTop3(top);
      } catch (e) {}
    }

    async function subscribeRealtime() {
      if (!sbClient || !currentUser) return;

      if (realtimeChannel) {
        try { await sbClient.removeChannel(realtimeChannel); } catch(_) {}
        realtimeChannel = null;
      }

      realtimeChannel = sbClient.channel(`moyofy_${BAR_ID}`)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'moyofy_users', filter: `bar_id=eq.${BAR_ID}` }, async (payload) => {
          try {
            if (payload?.new?.public_id && currentUser?.public_id === payload.new.public_id) {
              currentUser = { ...currentUser, ...payload.new };
              saveLocalUser(currentUser);
              updateProfileUI();
            }
            const top = await fetchLeaderboard();
            renderTop3(top);
          } catch (e) {}
        })
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'moyofy_gifts', filter: `bar_id=eq.${BAR_ID}` }, async (payload) => {
          try {
            const g = payload?.new;
            if (!g) return;
            if (currentUser?.public_id && (g.to_public_id === currentUser.public_id || g.from_public_id === currentUser.public_id)) {
              const top = await fetchLeaderboard();
              renderTop3(top);
            }
          } catch (_) {}
        })
        .subscribe((status) => {
          const live = $('pill-live');
          if (status === 'SUBSCRIBED') live.className = 'pill success';
          else live.className = 'pill warning';
        });
    }

    function setPriorityLabel() {
      if (!currentUser) return;
      const points = currentUser.points ?? 0;
      const mode = points >= 500 ? 'VIP' : points >= 250 ? 'Prioridad' : 'Normal';
      $('priority-mode').textContent = mode;
    }

    async function enterFlow({ guest=false }) {
      playSound('click-sound');

      const nick = normalizeNickname($('nickname').value);
      const email = safeTrim($('email').value).toLowerCase();

      if (!guest) {
        if (!nick || nick.length < 3) {
          showMessage('message-onboarding', 'Ingres√° un apodo v√°lido (m√≠nimo 3 caracteres).', 'warning');
          return;
        }
      }

      const finalNick = guest ? `Invitado${Math.floor(Math.random()*900+100)}` : nick;

      try {
        $('btn-enter').disabled = true;
        $('btn-guest').disabled = true;

        const user = await bootstrapUser({ nickname: finalNick, email: email || null, guest });
        currentUser = user;
        saveLocalUser(currentUser);

        setUIStateLoggedIn();
        updateProfileUI();
        setPriorityLabel();

        const top = await fetchLeaderboard();
        renderTop3(top);

        if (sbClient) await subscribeRealtime();

        playSound('success-sound');
        createEpicConfettiExplosion(window.innerWidth/2, window.innerHeight/2, 140);
        showMessage('message-profile', `Bienvenido ${escapeHtml(currentUser.nickname)} ¬∑ Perfil sincronizado`, 'success');

      } catch (e) {
        showMessage('message-onboarding', `No se pudo entrar: ${escapeHtml(e.message)}`, 'error');
      } finally {
        $('btn-enter').disabled = false;
        $('btn-guest').disabled = false;
      }
    }

    async function searchSongs() {
      playSound('click-sound');

      const query = safeTrim($('song-search').value);
      if (!query) {
        showMessage('message-container', 'Ingres√° el nombre de una canci√≥n o artista.', 'error');
        return;
      }
      if (!currentUser) {
        showMessage('message-container', 'Primero entr√° con tu apodo para aparecer en ranking.', 'warning');
        setUIStateLoggedOut();
        return;
      }

      setResultsLoading(query);

      try {
        const response = await fetch(`${API_BASE}/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ q: query })
        });

        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

        const data = await response.json();
        if (!data.ok) throw new Error(data.error || 'Error en la b√∫squeda');

        displaySearchResults(data.items || [], data.filterStats || null);

        if (data.items && data.items.length > 0) {
          showMessage('message-container', `Encontramos ${data.items.length} canciones apropiadas.`, 'success');
        } else {
          showMessage('message-container', `No encontramos canciones que cumplan con los criterios del bar.`, 'warning');
        }
      } catch (e) {
        $('results-container').innerHTML = `
          <div class="message error">
            <i class="fas fa-exclamation-circle"></i>
            Error al buscar canciones<br>
            <small>${escapeHtml(e.message || 'Intenta de nuevo m√°s tarde')}</small>
            <div class="small" style="margin-top:8px;">Tip: busc√° por artista + canci√≥n (ej: "Queen Bohemian Rhapsody")</div>
          </div>
        `;
      }
    }

    function displaySearchResults(items, stats) {
      const container = $('results-container');
      let html = '';

      if (stats) {
        html += `
          <div class="pill" style="display:inline-flex; margin: 6px 0 10px;">
            <i class="fas fa-filter"></i>
            ${stats.approved}/${stats.totalResults} aprobados (${stats.approvalRate}%)
            <span style="margin:0 8px;">‚Ä¢</span>
            "${escapeHtml(stats.query || '')}"
          </div>
        `;
      }

      if (!items || items.length === 0) {
        html += `
          <div class="message warning">
            <i class="fas fa-music"></i>
            No se encontraron canciones para el filtro del bar.
            <div class="small" style="margin-top:10px; text-align:left;">
              <b>Sugerencias:</b>
              <ul style="margin-top:8px; padding-left: 18px;">
                <li>Queen Bohemian Rhapsody</li>
                <li>Metallica Enter Sandman</li>
                <li>AC/DC Back In Black</li>
                <li>Nirvana Smells Like Teen Spirit</li>
              </ul>
            </div>
          </div>
        `;
        container.innerHTML = html;
        return;
      }

      items.forEach((item) => {
        const title = item?.snippet?.title || 'Sin t√≠tulo';
        const videoId = (item?.id?.videoId) || item?.id || '';
        if (!videoId) return;

        let artist = 'Artista';
        const channel = item?.snippet?.channelTitle || '';
        if (channel && !channel.toLowerCase().includes('vevo')) artist = channel;
        else if (title.includes('-')) artist = title.split('-')[0].trim();

        const displayTitle = title.length > 64 ? title.slice(0,64) + '...' : title;

        let durationSeconds = 0;
        let durationDisplay = '';
        if (item.contentDetails && item.contentDetails.duration) {
          durationSeconds = parseISODuration(item.contentDetails.duration);
          const formatted = formatDuration(durationSeconds);
          const cls = durationSeconds > MAX_DURATION_SECONDS ? 'too-long' : durationSeconds > 300 ? 'warning' : '';
          durationDisplay = `<div class="song-duration ${cls}"><i class="fas fa-clock"></i> ${formatted}${durationSeconds > MAX_DURATION_SECONDS ? ' (NO PERMITIDA)' : ''}</div>`;
        }

        const disabled = durationSeconds > MAX_DURATION_SECONDS ? 'disabled' : '';
        const btnLabel = durationSeconds > MAX_DURATION_SECONDS ? 'DEMASIADO LARGA' : 'AGREGAR';
        
        // ‚úÖ CORRECCI√ìN: Usar data attributes en lugar de onclick inline
        const songData = {
          videoId: videoId,
          title: title,
          artist: artist,
          duration: durationSeconds
        };

        html += `
          <div class="song-item" data-song='${safeJSON(songData)}'>
            <div class="song-info">
              <div class="song-title">${escapeHtml(displayTitle)}</div>
              <div class="song-artist">${escapeHtml(artist)}</div>
              ${durationDisplay}
              <div class="small" style="margin-top:6px;">
                <i class="fas fa-thumbs-up"></i>
                <button class="vote-btn" data-video-id="${escapeForAttribute(videoId)}">
                  Votar (+${ECONOMY.voteReward} MOYOS al creador)
                </button>
              </div>
            </div>
            <button class="add-btn" ${disabled} data-song-action="add">
              <i class="fas fa-plus"></i> ${btnLabel}
            </button>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // ‚úÖ NUEVO: Event delegation para manejar clicks en botones
    function setupEventDelegation() {
      const resultsContainer = $('results-container');
      if (!resultsContainer) return;

      // Eliminar listeners anteriores para evitar duplicados
      resultsContainer.removeEventListener('click', handleResultsContainerClick);
      
      // Agregar nuevo listener
      resultsContainer.addEventListener('click', handleResultsContainerClick);
    }

    // ‚úÖ NUEVO: Manejador de eventos para el contenedor de resultados
    function handleResultsContainerClick(event) {
      const target = event.target;
      
      // Manejar clic en bot√≥n "Agregar"
      const addBtn = target.closest('.add-btn');
      if (addBtn && !addBtn.disabled) {
        event.preventDefault();
        event.stopPropagation();
        
        // Obtener los datos de la canci√≥n desde el contenedor padre
        const songItem = addBtn.closest('.song-item');
        if (!songItem) return;
        
        try {
          const songData = JSON.parse(songItem.dataset.song || '{}');
          const { videoId, title, artist, duration } = songData;
          
          if (videoId && title) {
            suggestSong(videoId, title, artist, addBtn, duration || 0);
          }
        } catch (e) {
          console.error('Error parsing song data:', e);
          showMessage('message-container', 'Error interno al procesar la canci√≥n.', 'error');
        }
        return;
      }
      
      // Manejar clic en bot√≥n "Votar"
      const voteBtn = target.closest('.vote-btn');
      if (voteBtn) {
        event.preventDefault();
        event.stopPropagation();
        
        const videoId = voteBtn.dataset.videoId;
        if (videoId) {
          voteSong(videoId);
        }
        return;
      }
    }

    async function voteSong(videoId) {
      if (!currentUser) {
        showMessage('message-container', 'Entr√° con tu apodo para votar.', 'warning');
        return;
      }
      try {
        const r = await fetch(`${API_BASE}/v2/vote`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ barId: BAR_ID, fromPublicId: currentUser.public_id, videoId })
        });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || 'No se pudo votar');
        showMessage('message-container', `Voto enviado.`, 'success');
        await syncAll();
      } catch (e) {
        showMessage('message-container', `No se pudo votar: ${escapeHtml(e.message)}`, 'error');
      }
    }

    // ‚úÖ FUNCI√ìN MODIFICADA: suggestSong con event delegation
    async function suggestSong(videoId, title, artist, buttonEl, durationSeconds = 0) {
      playSound('click-sound');

      // Normalizar el elemento para obtener siempre el bot√≥n
      const resolvedButtonEl = resolveButtonEl(buttonEl);
      
      if (!resolvedButtonEl) {
        console.error('No se encontr√≥ el bot√≥n asociado');
        showMessage('message-container', 'Error interno: no se pudo encontrar el bot√≥n.', 'error');
        return;
      }

      if (durationSeconds > MAX_DURATION_SECONDS) {
        showMessage('message-container', `Esta canci√≥n dura ${formatDuration(durationSeconds)} y supera el l√≠mite (${MAX_DURATION_MINUTES} min).`, 'error');
        return;
      }

      if (!currentUser) {
        showMessage('message-container', 'Entr√° con tu apodo primero.', 'warning');
        setUIStateLoggedOut();
        return;
      }

      if (!canAddSong()) {
        const waitTime = Math.ceil((COOLDOWN_MS - (Date.now() - parseInt(localStorage.getItem('moyofy_last_add'),10))) / 60000);
        showMessage('message-container', `Esper√° ${waitTime} minuto(s) antes de agregar otra canci√≥n.`, 'warning');
        return;
      }

      // ‚úÖ MODIFICACI√ìN: no solicitar ubicaci√≥n y no bloquear por distancia
      if (GEOLOCATION_REQUIRED) {
        try {
          const coords = await requestLocation();
          if (!isUserNearBar(coords.latitude, coords.longitude)) {
            showMessage('message-container', 'Solo pod√©s agregar canciones estando cerca del local.', 'warning');
            return;
          }
        } catch (e) {
          showMessage('message-container', e?.message || 'No se pudo obtener la ubicaci√≥n.', 'error');
          return;
        }
      }

      if (requiresAuth) {
        showMessage('message-container', 'Necesit√°s autorizar YouTube para agregar canciones.', 'error');
        showAuthRequiredMessage();
        return;
      }

      // Guardar el estado original del bot√≥n
      const originalHTML = resolvedButtonEl.innerHTML;
      const originalDisabled = resolvedButtonEl.disabled;
      
      try {
        // Deshabilitar el bot√≥n y mostrar estado de carga
        resolvedButtonEl.disabled = true;
        resolvedButtonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AGREGANDO...';
        
        // Llamada a la API
        const response = await fetch(`${API_BASE}/suggest-song`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({
            videoId,
            title,
            userId: currentUser.public_id
          })
        });

        const data = await response.json();

        if (!response.ok || !data.ok) {
          if (data && data.requiresAuth) {
            requiresAuth = true;
            showAuthRequiredMessage();
            throw new Error('Necesit√°s autorizar YouTube');
          }
          if (data && (data.error === 'VIDEO_DUPLICATE' || data.message === 'El video ya existe en la playlist')) {
            throw new Error('Esa canci√≥n ya est√° en la playlist.');
          }
          throw new Error((data && (data.error || data.message)) || `Error HTTP ${response.status}`);
        }

        setLastAddTime();

        const award = await fetch(`${API_BASE}/v2/award-song`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            barId: BAR_ID,
            publicId: currentUser.public_id,
            videoId,
            title,
            artist,
            award: ECONOMY.pointsPerSong
          })
        });

        const awardData = await award.json();
        if (awardData.ok && awardData.user) {
          currentUser = awardData.user;
          saveLocalUser(currentUser);
          updateProfileUI();
          setPriorityLabel();
        }

        playSound('success-sound');
        const rect = resolvedButtonEl.getBoundingClientRect();
        const x = rect.left + rect.width/2;
        const y = rect.top + rect.height/2;
        createEpicConfettiExplosion(x, y, 110);
        createPointsAnimation(x, y, ECONOMY.pointsPerSong, "MOYOS");

        showMessage('message-container', `Canci√≥n agregada. +${ECONOMY.pointsPerSong} MOYOS`, 'success');

        // √âxito: cambiar el bot√≥n a estado "AGREGADA" permanentemente
        resolvedButtonEl.innerHTML = '<i class="fas fa-check"></i> AGREGADA';
        resolvedButtonEl.disabled = true;

        $('song-search').value = '';
        $('song-search').focus();

        await syncAll();
        
      } catch (e) {
        showMessage('message-container', `No se pudo agregar: ${escapeHtml(e.message)}`, 'error');
        
        // Error: restaurar el bot√≥n despu√©s de 2 segundos
        setTimeout(() => {
          if (resolvedButtonEl) {
            resolvedButtonEl.innerHTML = originalHTML;
            resolvedButtonEl.disabled = originalDisabled;
          }
        }, 2000);
        
      } finally {
        // Nota: La restauraci√≥n en caso de √©xito NO se hace aqu√≠
        // La restauraci√≥n en caso de error se maneja en el catch con un setTimeout
      }
    }

    async function sendGift() {
      playSound('click-sound');

      if (!currentUser) {
        showMessage('message-gifts', 'Entr√° con tu apodo para enviar regalos.', 'warning');
        return;
      }

      const toNick = normalizeNickname($('gift-to').value);
      const giftType = $('gift-type').value;
      if (!toNick || toNick.length < 3) {
        showMessage('message-gifts', 'Ingres√° el apodo del destinatario.', 'warning');
        return;
      }

      const amount = ECONOMY.baseGiftValues[giftType] || 10;
      const cost = Math.ceil(amount * ECONOMY.giftSendCostMultiplier);

      if ((currentUser.points ?? 0) < cost) {
        showMessage('message-gifts', `No ten√©s MOYOS suficientes. Necesit√°s ${cost} MOYOS.`, 'error');
        return;
      }

      try {
        const r = await fetch(`${API_BASE}/v2/gift`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            barId: BAR_ID,
            fromPublicId: currentUser.public_id,
            toNickname: toNick,
            giftType,
            amount
          })
        });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || 'No se pudo enviar el regalo');

        currentUser = data.fromUser;
        saveLocalUser(currentUser);
        updateProfileUI();
        setPriorityLabel();

        playSound('success-sound');
        createEpicConfettiExplosion(window.innerWidth/2, window.innerHeight/2, 120);
        createPointsAnimation(window.innerWidth/2, window.innerHeight/2, amount, "MOYOS");
        showMessage('message-gifts', `Regalo enviado a ${escapeHtml(toNick)} ¬∑ (${amount} MOYOS)`, 'success');

        $('gift-to').value = '';
        await syncAll();
      } catch (e) {
        showMessage('message-gifts', `No se pudo enviar: ${escapeHtml(e.message)}`, 'error');
      }
    }

    function startGame() {
      playSound('click-sound');
      const intro = $('intro-screen');
      intro.style.opacity = '0';
      setTimeout(() => {
        intro.style.display = 'none';
        $('main-container').style.display = 'block';
      }, 720);
    }

    async function init() {
      $('sound-toggle').addEventListener('click', toggleSound);

      $('btn-start').addEventListener('click', async () => {
        startGame();
        const ok = await fetchPublicConfig();
        const saved = loadLocalUser();

        if (saved?.public_id) {
          try {
            currentUser = await fetchMe(saved.public_id);
            saveLocalUser(currentUser);
            setUIStateLoggedIn();
            updateProfileUI();
            setPriorityLabel();
            const top = await fetchLeaderboard();
            renderTop3(top);
            if (ok && sbClient) await subscribeRealtime();
          } catch (e) {
            currentUser = null;
            clearLocalUser();
            setUIStateLoggedOut();
          }
        } else {
          setUIStateLoggedOut();
        }
        
        // ‚úÖ AJUSTE 2: setupEventDelegation() se llama solo una vez al final de init()
        // No se llama aqu√≠ para evitar duplicaci√≥n
      });

      $('btn-enter').addEventListener('click', () => enterFlow({ guest:false }));
      $('btn-guest').addEventListener('click', () => enterFlow({ guest:true }));

      $('btn-search').addEventListener('click', () => searchSongs());

      $('song-search').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchSongs();
        }
      });

      $('btn-change').addEventListener('click', () => {
        playSound('click-sound');
        if (confirm('¬øCambiar apodo? Esto crea un perfil nuevo.')) {
          clearLocalUser();
          currentUser = null;
          lastLevel = 1;
          setUIStateLoggedOut();
          showMessage('message-onboarding', 'Ingres√° tu nuevo apodo para continuar.', 'success');
        }
      });

      $('btn-refresh').addEventListener('click', async () => {
        playSound('click-sound');
        await syncAll();
        showMessage('message-profile', 'Sincronizado.', 'success');
      });

      $('btn-send-gift').addEventListener('click', () => sendGift());

      $('btn-open-leaderboard').addEventListener('click', async () => {
        playSound('click-sound');
        try {
          const top = await fetchLeaderboard();
          const lines = top.slice(0,10).map((u,i)=>`#${i+1} ${u.nickname} ¬∑ ${u.points} MOYOS`).join('\n');
          alert(lines || 'A√∫n no hay ranking.');
        } catch (e) {
          alert('No se pudo cargar ranking.');
        }
      });
      
      // ‚úÖ AJUSTE 2: setupEventDelegation() se llama solo una vez al final de init()
      setupEventDelegation();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>