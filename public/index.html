<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>MOYOFY ¬∑ Rafa's Bar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff004c;
      --primary-dark: #cc003d;
      --dark: #1a1a2e;
      --darker: #12121f;
      --light: #f8f9fa;
      --gray: #6c757d;
      --success: #00ffaa;
      --warning: #ffcc00;
      --danger: #ff6b6b;
      --purple: #9d4edd;
      --blue: #4361ee;
      --pink: #ff006e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: var(--darker);
      color: white;
      min-height: 100vh;
      padding: 20px;
      background: linear-gradient(135deg, var(--darker) 0%, #2d2d4f 100%);
      overflow-x: hidden;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      animation: fadeInDown 0.5s ease;
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      font-size: 3.5rem;
      margin-bottom: 10px;
      background: linear-gradient(45deg, #ff004c, #ff7300, #9d4edd, #4361ee);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(255, 0, 76, 0.3);
      position: relative;
      animation: gradientShift 5s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 4px;
      background: var(--primary);
      border-radius: 2px;
    }

    h2 {
      font-size: 1.2rem;
      color: #aaa;
      margin-bottom: 20px;
    }

    .user-panel {
      background: rgba(30, 30, 50, 0.9);
      backdrop-filter: blur(15px);
      border: 2px solid rgba(255, 0, 76, 0.4);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 25px;
      text-align: center;
      transition: all 0.4s ease;
      box-shadow: 0 10px 30px rgba(255, 0, 76, 0.2),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .user-panel:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(255, 0, 76, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .points-display {
      font-size: 2.8rem;
      font-weight: bold;
      color: var(--success);
      margin: 10px 0;
      text-shadow: 0 0 15px rgba(0, 255, 170, 0.7);
      background: linear-gradient(45deg, var(--success), #00cc88, #00ffaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }

    @keyframes pulseGlow {
      0% { text-shadow: 0 0 10px rgba(0, 255, 170, 0.5); }
      100% { text-shadow: 0 0 20px rgba(0, 255, 170, 0.8), 0 0 30px rgba(0, 255, 170, 0.4); }
    }

    .level-badge {
      display: inline-block;
      background: linear-gradient(45deg, var(--primary), var(--purple));
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 1rem;
      margin-top: 5px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(157, 78, 221, 0.4);
      animation: badgeFloat 3s ease-in-out infinite;
    }

    @keyframes badgeFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .search-box {
      background: rgba(25, 25, 40, 0.95);
      border: 2px solid var(--primary);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .search-box:hover {
      box-shadow: 0 15px 50px rgba(255, 0, 76, 0.3),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .search-label {
      display: block;
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: var(--light);
      font-weight: 500;
    }

    .search-input {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 15px;
      background: rgba(40, 40, 60, 0.9);
      color: white;
      font-size: 1.1rem;
      margin-bottom: 20px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(255, 0, 76, 0.3),
                  inset 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .search-input::placeholder {
      color: #888;
    }

    .search-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(45deg, var(--primary), var(--pink));
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 6px 20px rgba(255, 0, 76, 0.4);
      position: relative;
      overflow: hidden;
    }

    .search-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.7s ease;
    }

    .search-btn:hover::after {
      left: 100%;
    }

    .search-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(255, 0, 76, 0.6);
    }

    .song-item {
      background: rgba(35, 35, 55, 0.9);
      border-left: 5px solid var(--primary);
      padding: 18px;
      margin: 12px 0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .song-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 0, 76, 0.1), transparent);
      transform: translateX(-100%);
    }

    .song-item:hover::before {
      animation: shine 0.8s ease;
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .song-item:hover {
      background: rgba(45, 45, 65, 0.95);
      transform: translateX(8px) scale(1.02);
      border-left: 5px solid var(--success);
      box-shadow: 0 8px 25px rgba(0, 255, 170, 0.3);
    }

    .song-info {
      flex: 1;
    }

    .song-title {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: var(--light);
    }

    .song-artist {
      color: #aaa;
      font-size: 0.9rem;
    }

    .song-duration {
      font-size: 0.8rem;
      color: var(--gray);
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: inline-block;
      margin-top: 5px;
    }

    .song-duration.warning {
      color: var(--warning);
      background: rgba(255, 204, 0, 0.1);
      border-color: rgba(255, 204, 0, 0.2);
    }

    .song-duration.too-long {
      color: var(--danger);
      background: rgba(255, 107, 107, 0.1);
      border-color: rgba(255, 107, 107, 0.2);
      text-decoration: line-through;
    }

    .add-btn {
      background: linear-gradient(45deg, var(--success), #00cc88);
      color: black;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 110px;
      box-shadow: 0 4px 15px rgba(0, 255, 170, 0.4);
      position: relative;
      overflow: hidden;
    }

    .add-btn:hover {
      background: linear-gradient(45deg, #00cc88, var(--success));
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(0, 255, 170, 0.6);
    }

    .add-btn:disabled {
      background: linear-gradient(45deg, #666, #888);
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .add-btn:active {
      transform: scale(0.98);
    }

    .message {
      padding: 18px;
      border-radius: 12px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
      animation: messageAppear 0.5s ease;
      backdrop-filter: blur(10px);
      border: 2px solid transparent;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    @keyframes messageAppear {
      0% { opacity: 0; transform: translateY(-10px) scale(0.9); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .message.success {
      background: rgba(0, 255, 170, 0.2);
      border-color: rgba(0, 255, 170, 0.4);
      color: var(--success);
      animation: pulse 2s infinite;
    }

    .message.error {
      background: rgba(255, 107, 107, 0.2);
      border-color: rgba(255, 107, 107, 0.4);
      color: var(--danger);
    }

    .message.warning {
      background: rgba(255, 204, 0, 0.2);
      border-color: rgba(255, 204, 0, 0.4);
      color: var(--warning);
    }

    .duration-warning {
      background: rgba(255, 204, 0, 0.1);
      border: 2px solid rgba(255, 204, 0, 0.3);
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
      color: var(--warning);
      backdrop-filter: blur(5px);
    }

    .duration-warning i {
      margin-right: 10px;
      color: var(--warning);
    }

    .auth-required {
      background: rgba(255, 69, 58, 0.2);
      border: 2px solid rgba(255, 69, 58, 0.4);
      color: var(--danger);
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 20px;
      border-radius: 12px;
      margin: 15px 0;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(255, 69, 58, 0.3);
    }

    .auth-required:hover {
      background: rgba(255, 69, 58, 0.3);
      transform: scale(1.03);
      box-shadow: 0 8px 25px rgba(255, 69, 58, 0.4);
    }

    .auth-required i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .gamification-panel {
      background: linear-gradient(135deg, rgba(30, 30, 50, 0.9), rgba(45, 45, 70, 0.9));
      border: 2px solid rgba(0, 255, 170, 0.4);
      border-radius: 20px;
      padding: 25px;
      margin-top: 25px;
      backdrop-filter: blur(15px);
      box-shadow: 0 10px 30px rgba(0, 255, 170, 0.2);
      position: relative;
      overflow: hidden;
    }

    .gamification-panel::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(
        transparent, 
        rgba(0, 255, 170, 0.1), 
        transparent 30%
      );
      animation: rotate 8s linear infinite;
    }

    .gamification-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      color: var(--success);
      font-weight: bold;
      font-size: 1.3rem;
      position: relative;
      z-index: 2;
    }

    .progress-container {
      background: rgba(40, 40, 60, 0.8);
      border-radius: 15px;
      padding: 15px;
      margin: 15px 0;
      position: relative;
      z-index: 2;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: #aaa;
    }

    .progress-bar {
      height: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff004c, #ff7300, #00ffaa);
      border-radius: 8px;
      transition: width 1s ease-in-out;
      position: relative;
      overflow: hidden;
      min-width: 8px;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite;
      transform: translateX(-100%);
    }

    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }

    .xp-display {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.85rem;
      color: #888;
    }

    .achievements-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
      position: relative;
      z-index: 2;
    }

    .achievement-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .achievement-card:hover {
      transform: translateY(-5px);
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--success);
      box-shadow: 0 5px 15px rgba(0, 255, 170, 0.3);
    }

    .achievement-card.locked {
      opacity: 0.5;
      filter: grayscale(1);
    }

    .achievement-card.unlocked {
      border-color: var(--success);
      background: rgba(0, 255, 170, 0.05);
    }

    .achievement-icon {
      font-size: 2rem;
      margin-bottom: 10px;
      display: block;
    }

    .achievement-name {
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .achievement-desc {
      font-size: 0.8rem;
      color: #aaa;
      margin-bottom: 10px;
    }

    .achievement-progress {
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
    }

    .achievement-progress-fill {
      height: 100%;
      background: var(--success);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .challenges-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      position: relative;
      z-index: 2;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .challenge-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .challenge-item:last-child {
      border-bottom: none;
    }

    .challenge-info {
      flex: 1;
    }

    .challenge-reward {
      background: linear-gradient(45deg, var(--warning), #ff9900);
      color: black;
      padding: 5px 12px;
      border-radius: 15px;
      font-weight: bold;
      font-size: 0.9rem;
      min-width: 80px;
      text-align: center;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
      position: relative;
      z-index: 2;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--success);
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #aaa;
    }

    .loading {
      text-align: center;
      padding: 30px;
      color: var(--gray);
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    footer {
      text-align: center;
      margin-top: 40px;
      color: #888;
      font-size: 0.9rem;
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2.5rem;
      }

      .container {
        padding: 10px;
      }

      .search-box {
        padding: 20px;
      }

      .user-panel {
        padding: 20px;
      }

      .achievements-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .filter-stats {
      background: rgba(108, 117, 125, 0.2);
      border: 1px solid rgba(108, 117, 125, 0.4);
      border-radius: 10px;
      padding: 12px 15px;
      margin: 15px 0;
      font-size: 0.9rem;
      backdrop-filter: blur(5px);
    }

    .change-username-btn {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s ease;
    }

    .change-username-btn:hover {
      background: rgba(255, 0, 76, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 0, 76, 0.3);
    }

    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      background: rgba(255, 0, 76, 0.1);
      border-radius: 50%;
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }

    @keyframes rotate {
      100% { transform: rotate(360deg); }
    }

    .intro-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d4f 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.8s ease;
    }

    .intro-title {
      font-size: 4.5rem;
      font-weight: bold;
      background: linear-gradient(45deg, #ff004c, #ff7300, #00ffaa, #4361ee);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 3s ease infinite, titlePulse 2s ease-in-out infinite;
      text-align: center;
      margin-bottom: 20px;
    }

    @keyframes titlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .intro-subtitle {
      font-size: 1.5rem;
      color: #aaa;
      margin-bottom: 40px;
      text-align: center;
      max-width: 600px;
    }

    .start-button {
      background: linear-gradient(45deg, #ff004c, #ff7300);
      color: white;
      border: none;
      padding: 20px 50px;
      font-size: 1.3rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(255, 0, 76, 0.4);
      position: relative;
      overflow: hidden;
    }

    .start-button:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 15px 40px rgba(255, 0, 76, 0.6);
    }

    .start-button:active {
      transform: translateY(0) scale(0.98);
    }

    .level-up-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 5rem;
      font-weight: bold;
      color: #00ffaa;
      text-shadow: 0 0 30px rgba(0, 255, 170, 0.8);
      z-index: 10001;
      pointer-events: none;
      animation: levelUpPop 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes levelUpPop {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      20% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
      40% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      60% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); opacity: 1; }
      80% { transform: translate(-50%, -50%) scale(1.1) rotate(-5deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1.3); opacity: 0; }
    }

    .sound-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .sound-toggle:hover {
      background: rgba(255, 0, 76, 0.2);
      transform: scale(1.1);
    }

    .sound-toggle i {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .confetti {
      position: absolute;
      width: 15px;
      height: 15px;
      background: var(--primary);
      top: 0;
      opacity: 0;
    }

    .confetti:nth-child(1) { background: #ff004c; }
    .confetti:nth-child(2) { background: #00ffaa; }
    .confetti:nth-child(3) { background: #ffcc00; }
    .confetti:nth-child(4) { background: #9d4edd; }
    .confetti:nth-child(5) { background: #4361ee; }
    .confetti:nth-child(6) { background: #ff006e; }
    .confetti:nth-child(7) { background: #00ccff; }
    .confetti:nth-child(8) { background: #ff9900; }
    .confetti:nth-child(9) { background: #aa00ff; }
    .confetti:nth-child(10) { background: #00ff88; }

    @keyframes confetti-explosion {
      0% {
        opacity: 1;
        transform: translate(0, 0) rotate(0deg) scale(0);
      }
      10% {
        opacity: 1;
        transform: translate(var(--tx), var(--ty)) rotate(var(--r)) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(calc(var(--tx) * 1.5), calc(var(--ty) * 1.5 + 100vh)) rotate(calc(var(--r) * 3)) scale(0);
      }
    }

    .points-animation {
      position: fixed;
      color: #00ffaa;
      font-weight: bold;
      font-size: 1.8rem;
      text-shadow: 0 0 10px rgba(0, 255, 170, 0.8);
      z-index: 10001;
      pointer-events: none;
      animation: pointsFloat 2.5s ease-out forwards;
    }

    @keyframes pointsFloat {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(0.8);
      }
      20% {
        opacity: 1;
        transform: translate(0, -50px) scale(1.5);
      }
      40% {
        opacity: 1;
        transform: translate(0, -100px) scale(1.2);
      }
      60% {
        opacity: 1;
        transform: translate(0, -150px) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(0, -200px) scale(0.5);
      }
    }

    .emoji-explosion {
      position: fixed;
      font-size: 2.5rem;
      z-index: 10001;
      pointer-events: none;
      animation: emojiFloat 3s ease-out forwards;
    }

    @keyframes emojiFloat {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(0.5) rotate(0deg);
      }
      20% {
        opacity: 1;
        transform: translate(var(--tx1), var(--ty1)) scale(1.5) rotate(180deg);
      }
      40% {
        opacity: 1;
        transform: translate(var(--tx2), var(--ty2)) scale(1.2) rotate(360deg);
      }
      60% {
        opacity: 1;
        transform: translate(var(--tx3), var(--ty3)) scale(1) rotate(540deg);
      }
      100% {
        opacity: 0;
        transform: translate(var(--tx4), var(--ty4)) scale(0) rotate(720deg);
      }
    }

    .firework {
      position: fixed;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      box-shadow: 0 0 10px currentColor;
      z-index: 10001;
      pointer-events: none;
      animation: fireworkExplode 2s ease-out forwards;
    }

    @keyframes fireworkExplode {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
      }
      30% {
        opacity: 1;
        transform: translate(0, -100px) scale(1);
      }
      31% {
        opacity: 1;
        transform: translate(0, -100px) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0);
      }
    }
  </style>
</head>
<body>
  <div class="intro-screen" id="intro-screen">
    <h1 class="intro-title">üé∏ MOYOFY</h1>
    <p class="intro-subtitle">Conecta con la m√∫sica. Conecta con la gente.<br>Tu vibra tiene valor ¬∑ Rafa's Bar</p>
    <button class="start-button" onclick="startGame()">
      <i class="fas fa-play"></i> ENTRAR AL BAR
    </button>
    <div style="margin-top: 40px; color: #666; text-align: center;">
      <p><i class="fas fa-map-marker-alt"></i> Ubicaci√≥n: Rafa's Bar, Costa Rica</p>
      <p><i class="fas fa-music"></i> Solo g√©neros rock/metal/alternativo</p>
      <p><i class="fas fa-clock"></i> L√≠mite: M√°ximo 7 minutos por canci√≥n</p>
      <p><i class="fas fa-trophy"></i> Gana puntos y sube de nivel</p>
    </div>
  </div>

  <div class="particles" id="particles-container"></div>

  <div class="sound-toggle" onclick="toggleSound()" id="sound-toggle">
    <i class="fas fa-volume-up" id="sound-icon"></i>
  </div>

  <div class="container" id="main-container" style="display: none;">
    <header>
      <h1>üé∏ MOYOFY</h1>
      <h2>Tu vibra tiene valor ¬∑ Rafa's Bar</h2>
    </header>

    <div class="user-panel">
      <div id="nickname-section" style="display: none;">
        <h3>üë§ ¬øC√≥mo te quieres llamar?</h3>
        <input type="text" id="nickname" placeholder="Ej: RockMaster69" class="search-input">
        <button onclick="setNickname()" class="search-btn">
          <i class="fas fa-sign-in-alt"></i> ENTRAR AL BAR
        </button>
        <p style="color: #888; margin-top: 10px; font-size: 0.9rem;">
          * Usa un nombre √∫nico para que aparezcas en el ranking
        </p>
      </div>

      <div id="user-profile" style="display: none;">
        <h3 id="welcome-text">¬°Bienvenido, <span id="user-nickname">usuario</span>!</h3>
        <div class="points-display">
          <i class="fas fa-coins"></i> <span id="user-points">100</span> MOYOS
        </div>
        <div class="level-badge">
          <i class="fas fa-level-up-alt"></i> Nivel <span id="user-level">1</span>
        </div>
        <div style="margin-top: 10px; font-size: 0.9rem; color: #aaa;">
          <i class="fas fa-music"></i> Canciones: <span id="songs-added">0</span> ‚Ä¢ 
          <i class="fas fa-fire"></i> Racha: <span id="streak-days">1</span> d√≠as
        </div>
        <button onclick="changeUsername()" class="change-username-btn">
          <i class="fas fa-user-edit"></i> Cambiar apodo
        </button>
      </div>
    </div>

    <div class="search-box">
      <h3>üéµ Buscar canci√≥n</h3>
      <p style="color: #aaa; margin-bottom: 15px; font-size: 0.95rem;">
        Solo se permiten g√©neros afines al rock (cl√°sico, alternativo, metal, punk, indie, industrial, etc.).
        <br>
        <strong style="color: var(--warning); display: block; margin-top: 5px;">
          <i class="fas fa-clock"></i> L√çMITE: M√°ximo 7 minutos por canci√≥n
        </strong>
        <span style="color: var(--success); display: inline-block; margin-top: 5px;">
          <i class="fas fa-check-circle"></i> ¬°Gana MOYOS por cada canci√≥n que agregues!
        </span>
      </p>

      <input type="text" id="song-search" placeholder="Busca tu canci√≥n favorita..." class="search-input">
      <button onclick="searchSongs()" class="search-btn">
        <i class="fas fa-search"></i> BUSCAR CANCIONES
      </button>

      <div id="auth-required-message" style="display: none;" class="auth-required" onclick="redirectToAuth()">
        <i class="fas fa-lock"></i> <strong>üîê ¬°NECESITAS AUTENTICARTE CON YOUTUBE!</strong><br>
        Para agregar canciones a la playlist, debes autorizar MOYOFY con tu cuenta de Google.<br>
        <small>(Solo una vez por sesi√≥n)</small>
      </div>

      <div id="message-container"></div>

      <div class="results-container" id="results-container">
        <div class="loading">
          <div class="spinner"></div>
          <p>¬øQu√© canci√≥n quieres agregar hoy?</p>
        </div>
      </div>
    </div>

    <div class="gamification-panel">
      <div class="gamification-title">
        <i class="fas fa-trophy"></i> üèÜ TU PROGRESO EN EL BAR
      </div>

      <div class="progress-container">
        <div class="progress-header">
          <span id="current-level-display">Nivel 1</span>
          <span id="next-level-display">Nivel 2</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="level-progress-fill" style="width: 0%"></div>
        </div>
        <div class="xp-display">
          <span id="current-xp-display">0/100 XP</span>
          <span id="xp-to-next">100 XP para subir</span>
        </div>
      </div>

      <div class="stats-container" id="stats-container"></div>

      <h4 style="margin: 20px 0 10px 0; color: var(--success); position: relative; z-index: 2;">
        <i class="fas fa-medal"></i> LOGROS
      </h4>
      <div class="achievements-container" id="achievements-container"></div>

      <h4 style="margin: 20px 0 10px 0; color: var(--warning); position: relative; z-index: 2;">
        <i class="fas fa-bullseye"></i> DESAF√çOS ACTIVOS
      </h4>
      <div class="challenges-container" id="challenges-container"></div>
    </div>
  </div>

  <footer>
    <p>MOYOFY PREMIUM v2 ¬∑ Sistema de entretenimiento social para bares</p>
    <p>M√∫sica impulsada por YouTube ¬∑ L√≠mite de 7 minutos por canci√≥n ¬∑ ¬© 2025 Abundia.io</p>
  </footer>

  <div class="confetti-container" id="confetti-container"></div>

  <audio id="success-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
  </audio>
  <audio id="level-up-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-trumpet-2018.mp3" type="audio/mpeg">
  </audio>
  <audio id="click-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" type="audio/mpeg">
  </audio>
  <audio id="explosion-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-fireworks-explosion-3038.mp3" type="audio/mpeg">
  </audio>

  <script>
    const BAR_LOCATION = { lat: 9.93422, lng: -84.06894 };
    const RADIUS_METERS = 20000;
    const COOLDOWN_MS = 5 * 60 * 1000;
    const MAX_DURATION_MINUTES = 7;
    const MAX_DURATION_SECONDS = MAX_DURATION_MINUTES * 60;
    
    let soundEnabled = true;
    let currentUser = null;
    let API_BASE = window.location.origin;
    let requiresAuth = false;
    let lastLevel = 1;

    const GAMIFICATION = {
      pointsPerSong: 10,
      xpPerLevel: 100,
      
      achievements: [
        { id: 'first-song', name: 'üéµ Primer Hit', description: 'Agrega tu primera canci√≥n', icon: 'fa-music', goal: 1, reward: 50 },
        { id: 'rock-enthusiast', name: 'üé∏ Rockero', description: 'Agrega 5 canciones de rock', icon: 'fa-guitar', goal: 5, reward: 100 },
        { id: 'metal-head', name: 'ü§ò Metalero', description: 'Agrega 3 canciones de metal', icon: 'fa-volume-up', goal: 3, reward: 150 },
        { id: 'streak-3', name: 'üî• Racha Caliente', description: '3 d√≠as consecutivos activo', icon: 'fa-fire', goal: 3, reward: 200 },
        { id: 'genre-explorer', name: 'üß≠ Explorador', description: 'Canciones en 3 g√©neros diferentes', icon: 'fa-compass', goal: 3, reward: 250 },
        { id: 'bar-regular', name: 'üçª Regular del Bar', description: '10 canciones agregadas', icon: 'fa-beer', goal: 10, reward: 500 }
      ],
      
      challenges: [
        { id: 'challenge-1', name: 'Agrega una canci√≥n de Queen', description: 'Gana 50 MOYOS extra', reward: 50, type: 'specific-artist', target: 'Queen' },
        { id: 'challenge-2', name: 'Agrega 3 canciones hoy', description: 'Gana 100 MOYOS extra', reward: 100, type: 'daily-count', target: 3 },
        { id: 'challenge-3', name: 'Completa tu primer logro', description: 'Gana 25 MOYOS extra', reward: 25, type: 'first-achievement', target: 1 }
      ]
    };

    function playSound(soundId) {
      if (!soundEnabled) return;
      const sound = document.getElementById(soundId);
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Error reproduciendo sonido:", e));
      }
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const icon = document.getElementById('sound-icon');
      icon.className = soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
      if (soundEnabled) playSound('click-sound');
    }

    function formatDuration(seconds) {
      if (!seconds) return '--:--';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function parseISODuration(duration) {
      if (!duration) return 0;
      const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return 0;
      const hours = parseInt(match[1] || '0', 10);
      const minutes = parseInt(match[2] || '0', 10);
      const seconds = parseInt(match[3] || '0', 10);
      return hours * 3600 + minutes * 60 + seconds;
    }

    function createEpicConfettiExplosion(x, y, intensity = 100) {
      playSound('explosion-sound');
      const container = document.getElementById('confetti-container');
      for (let i = 0; i < intensity; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        const size = Math.random() * 20 + 8;
        confetti.style.width = `${size}px`;
        confetti.style.height = `${size}px`;
        confetti.style.left = `${x}px`;
        confetti.style.top = `${y}px`;
        confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
        if (Math.random() > 0.7) {
          confetti.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
        } else if (Math.random() > 0.5) {
          confetti.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
        }
        const tx = (Math.random() - 0.5) * 1200;
        const ty = (Math.random() - 0.5) * 1200;
        const r = Math.random() * 720;
        confetti.style.setProperty('--tx', `${tx}px`);
        confetti.style.setProperty('--ty', `${ty}px`);
        confetti.style.setProperty('--r', `${r}deg`);
        confetti.style.animation = `confetti-explosion ${Math.random() * 3000 + 4000}ms ease-out forwards`;
        confetti.style.animationDelay = `${Math.random() * 500}ms`;
        container.appendChild(confetti);
        setTimeout(() => confetti.remove(), 7000);
      }
    }

    function createPointsAnimation(x, y, points) {
      const container = document.getElementById('confetti-container');
      const pointsElement = document.createElement('div');
      pointsElement.className = 'points-animation';
      pointsElement.textContent = `+${points} MOYOS`;
      pointsElement.style.left = `${x}px`;
      pointsElement.style.top = `${y}px`;
      container.appendChild(pointsElement);
      setTimeout(() => pointsElement.remove(), 2500);
    }

    function startGame() {
      playSound('click-sound');
      const introScreen = document.getElementById('intro-screen');
      introScreen.style.opacity = '0';
      setTimeout(() => {
        introScreen.style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        const savedUser = localStorage.getItem('moyofy_user');
        if (savedUser) {
          currentUser = JSON.parse(savedUser);
          showUserProfile();
          updateGamificationUI();
          lastLevel = calculateLevel(currentUser.points || 100).level;
        } else {
          showNicknameSection();
        }
      }, 800);
    }

    function calculateLevel(points) {
      const level = Math.floor(points / GAMIFICATION.xpPerLevel) + 1;
      const currentXp = points % GAMIFICATION.xpPerLevel;
      const xpPercentage = (currentXp / GAMIFICATION.xpPerLevel) * 100;
      const xpNeeded = GAMIFICATION.xpPerLevel - currentXp;
      return { level, currentXp, xpPercentage, xpNeeded, nextLevel: level + 1 };
    }

    function updateGamificationUI() {
      if (!currentUser) return;
      const points = currentUser.points || 100;
      const stats = calculateLevel(points);
      if (stats.level > lastLevel) {
        triggerLevelUpAnimation(stats.level);
        lastLevel = stats.level;
      }
      document.getElementById('level-progress-fill').style.width = `${stats.xpPercentage}%`;
      document.getElementById('current-level-display').textContent = `Nivel ${stats.level}`;
      document.getElementById('next-level-display').textContent = `Nivel ${stats.nextLevel}`;
      document.getElementById('current-xp-display').textContent = `${stats.currentXp}/${GAMIFICATION.xpPerLevel} XP`;
      document.getElementById('xp-to-next').textContent = `${stats.xpNeeded} XP para subir`;
      updateStatsUI();
      updateAchievementsUI();
      updateChallengesUI();
    }

    function triggerLevelUpAnimation(level) {
      playSound('level-up-sound');
      const levelUp = document.createElement('div');
      levelUp.className = 'level-up-animation';
      levelUp.textContent = `üéâ NIVEL ${level}!`;
      document.body.appendChild(levelUp);
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      createEpicConfettiExplosion(centerX, centerY, 200);
      setTimeout(() => levelUp.remove(), 2000);
    }

    function showNicknameSection() {
      document.getElementById('nickname-section').style.display = 'block';
      document.getElementById('user-profile').style.display = 'none';
    }

    function showUserProfile() {
      if (!currentUser) return;
      document.getElementById('nickname-section').style.display = 'none';
      document.getElementById('user-profile').style.display = 'block';
      updateUserProfile();
    }

    function updateUserProfile() {
      if (!currentUser) return;
      document.getElementById('user-nickname').textContent = currentUser.nickname;
      document.getElementById('user-points').textContent = currentUser.points || 100;
      document.getElementById('user-level').textContent = calculateLevel(currentUser.points || 100).level;
      document.getElementById('songs-added').textContent = currentUser.songsAdded || 0;
      document.getElementById('streak-days').textContent = currentUser.streak || 1;
      updateGamificationUI();
      checkAchievements();
    }

    function setNickname() {
      playSound('click-sound');
      const nickname = document.getElementById('nickname').value.trim();
      if (!nickname || nickname.length < 3) {
        showMessage('‚ö†Ô∏è Ingresa un apodo v√°lido (m√≠nimo 3 caracteres)', 'warning');
        return;
      }
      const userId = `user_${nickname.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${Date.now()}`;
      currentUser = {
        id: userId,
        nickname: nickname,
        points: 100,
        songsAdded: 0,
        streak: 1,
        joinDate: new Date().toISOString()
      };
      localStorage.setItem('moyofy_user', JSON.stringify(currentUser));
      showUserProfile();
      playSound('success-sound');
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      createEpicConfettiExplosion(centerX, centerY, 150);
      showMessage(`üéâ ¬°Bienvenido ${nickname} al Rafa's Bar! 100 MOYOS de regalo`, 'success');
    }

    function updateStatsUI() {
      const container = document.getElementById('stats-container');
      if (!container) return;
      const songsAdded = currentUser.songsAdded || 0;
      const streak = currentUser.streak || 1;
      const points = currentUser.points || 100;
      const level = calculateLevel(points).level;
      const stats = [
        { label: 'Canciones', value: songsAdded, icon: 'üéµ' },
        { label: 'Racha', value: `${streak} d√≠as`, icon: 'üî•' },
        { label: 'Nivel', value: level, icon: '‚≠ê' },
        { label: 'MOYOS', value: points, icon: 'üí∞' }
      ];
      let html = '';
      stats.forEach(stat => {
        html += `<div class="stat-card"><div class="stat-icon" style="font-size: 1.5rem; margin-bottom: 8px;">${stat.icon}</div><div class="stat-value">${stat.value}</div><div class="stat-label">${stat.label}</div></div>`;
      });
      container.innerHTML = html;
    }

    function updateAchievementsUI() {
      const container = document.getElementById('achievements-container');
      if (!container) return;
      const songsAdded = currentUser.songsAdded || 0;
      const achievements = currentUser.achievements || {};
      let html = '';
      GAMIFICATION.achievements.forEach(achievement => {
        const progress = achievements[achievement.id] || 0;
        const isUnlocked = progress >= achievement.goal;
        const progressPercent = Math.min((progress / achievement.goal) * 100, 100);
        html += `<div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" title="${achievement.description} (${progress}/${achievement.goal})"><div class="achievement-icon"><i class="fas ${achievement.icon}"></i></div><div class="achievement-name">${achievement.name}</div><div class="achievement-desc">${achievement.description}</div><div class="achievement-progress"><div class="achievement-progress-fill" style="width: ${progressPercent}%"></div></div>${isUnlocked ? '<div style="color: var(--success); font-size: 0.7rem; margin-top: 5px;">¬°COMPLETADO!</div>' : ''}</div>`;
      });
      container.innerHTML = html;
    }

    function updateChallengesUI() {
      const container = document.getElementById('challenges-container');
      if (!container) return;
      let html = '';
      GAMIFICATION.challenges.forEach(challenge => {
        html += `<div class="challenge-item"><div class="challenge-info"><div style="font-weight: bold; font-size: 0.95rem;">${challenge.name}</div><div style="font-size: 0.8rem; color: #aaa;">${challenge.description}</div></div><div class="challenge-reward">+${challenge.reward} MOYOS</div></div>`;
      });
      container.innerHTML = html;
    }

    function checkAchievements() {
      if (!currentUser) return;
      const songsAdded = currentUser.songsAdded || 0;
      const achievements = currentUser.achievements || {};
      let newAchievements = [];
      GAMIFICATION.achievements.forEach(achievement => {
        let progress = achievements[achievement.id] || 0;
        switch (achievement.id) {
          case 'first-song': progress = songsAdded >= 1 ? 1 : 0; break;
          case 'rock-enthusiast': progress = Math.min(songsAdded, achievement.goal); break;
          case 'metal-head': progress = Math.min(Math.floor(songsAdded * 0.3), achievement.goal); break;
          case 'streak-3': progress = Math.min(currentUser.streak || 1, achievement.goal); break;
          case 'genre-explorer': progress = songsAdded >= 10 ? 3 : Math.floor(songsAdded / 3); break;
          case 'bar-regular': progress = Math.min(songsAdded, achievement.goal); break;
        }
        achievements[achievement.id] = progress;
        if (progress >= achievement.goal && (!currentUser.unlockedAchievements || !currentUser.unlockedAchievements.includes(achievement.id))) {
          newAchievements.push(achievement);
          if (!currentUser.unlockedAchievements) currentUser.unlockedAchievements = [];
          currentUser.unlockedAchievements.push(achievement.id);
        }
      });
      currentUser.achievements = achievements;
      localStorage.setItem('moyofy_user', JSON.stringify(currentUser));
      if (newAchievements.length > 0) {
        newAchievements.forEach(achievement => {
          showMessage(`üèÜ ¬°Logro desbloqueado: ${achievement.name}! +${achievement.reward} MOYOS`, 'success');
          currentUser.points += achievement.reward;
          updateUserProfile();
        });
      }
    }

    async function searchSongs() {
      playSound('click-sound');
      const query = document.getElementById('song-search').value.trim();
      if (!query) {
        showMessage('‚ùå Ingresa el nombre de una canci√≥n o artista', 'error');
        return;
      }
      if (!currentUser) {
        showMessage('‚ö†Ô∏è Necesitas ingresar tu nombre primero', 'warning');
        showNicknameSection();
        return;
      }
      document.getElementById('results-container').innerHTML = `<div class="loading"><div class="spinner"></div><p>Buscando canciones de rock y metal...</p><p style="margin-top: 10px; font-size: 0.9rem; color: #aaa;"><strong>${query}</strong></p><p style="font-size: 0.8rem; color: #888; margin-top: 5px;"><i class="fas fa-clock"></i> Solo canciones de hasta ${MAX_DURATION_MINUTES} minutos</p></div>`;
      try {
        const response = await fetch(`${API_BASE}/search`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ q: query })
        });
        if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
        const data = await response.json();
        if (!data.ok) throw new Error(data.error || 'Error en la b√∫squeda');
        displaySearchResults(data.items, data.filterStats, data.warnings);
        if (data.items && data.items.length > 0) {
          showMessage(`‚úÖ ¬°Encontramos ${data.items.length} canciones apropiadas para el bar!`, 'success');
        } else {
          let warningMsg = 'üîç No encontramos canciones que cumplan con los criterios del bar';
          if (data.warnings && data.warnings.length > 0) warningMsg += `<br><small>${data.warnings[0]}</small>`;
          showMessage(warningMsg, 'warning');
        }
      } catch (error) {
        console.error('Error en b√∫squeda:', error);
        document.getElementById('results-container').innerHTML = `<div class="message error"><i class="fas fa-exclamation-circle"></i> <strong>Error al buscar canciones</strong><br><small>${error.message || 'Intenta de nuevo m√°s tarde'}</small><p style="margin-top: 10px; font-size: 0.9rem;">Tip: Busca por artista o canci√≥n espec√≠fica (ej: "Queen Bohemian Rhapsody", "Metallica Enter Sandman")</p></div>`;
      }
    }

    function displaySearchResults(items, stats, warnings = []) {
      const container = document.getElementById('results-container');
      let html = '';
      if (warnings && warnings.length > 0) {
        html += `<div class="duration-warning"><i class="fas fa-clock"></i>${warnings.join('<br>')}</div>`;
      }
      if (stats) {
        html += `<div class="filter-stats"><i class="fas fa-filter"></i> <strong>Filtro activo:</strong> ${stats.approved}/${stats.totalResults} aprobados (${stats.approvalRate}%)<br><small>B√∫squeda: "${stats.query || 'rock'}" | L√≠mite: ${MAX_DURATION_MINUTES} min</small></div>`;
      }
      if (!items || items.length === 0) {
        html += `<div class="message warning"><i class="fas fa-music"></i> No se encontraron canciones que cumplan con los criterios de Rafa's Bar.<p style="margin-top: 10px; font-size: 0.9rem; color: #ddd;">‚ö† Recuerda: Solo se permiten g√©neros rock y sus variantes.<br>‚ö† <strong>L√≠mite de duraci√≥n:</strong> M√°ximo ${MAX_DURATION_MINUTES} minutos<br><strong>Sugerencias:</strong></p><ul style="text-align: left; margin-top: 10px; padding-left: 20px; font-size: 0.9rem;"><li>"Queen Bohemian Rhapsody" (5:55)</li><li>"Metallica Enter Sandman" (5:31)</li><li>"AC/DC Back in Black" (4:16)</li><li>"Nirvana Smells Like Teen Spirit" (5:01)</li><li>"Guns N' Roses Sweet Child O' Mine" (5:56)</li></ul></div>`;
        container.innerHTML = html;
        return;
      }
      items.forEach((item, index) => {
        const title = item.snippet.title;
        const videoId = item.id.videoId || item.id;
        let artist = 'Artista desconocido';
        if (item.snippet.channelTitle && !item.snippet.channelTitle.toLowerCase().includes('vevo')) {
          artist = item.snippet.channelTitle;
        } else if (title.includes('-')) {
          artist = title.split('-')[0].trim();
        } else if (title.includes('by')) {
          artist = title.split('by')[1]?.trim() || item.snippet.channelTitle;
        }
        const displayTitle = title.length > 60 ? title.substring(0, 60) + '...' : title;
        let durationDisplay = '';
        let durationSeconds = 0;
        if (item.contentDetails && item.contentDetails.duration) {
          durationSeconds = parseISODuration(item.contentDetails.duration);
          const formattedDuration = formatDuration(durationSeconds);
          const durationClass = durationSeconds > MAX_DURATION_SECONDS ? 'too-long' : durationSeconds > 300 ? 'warning' : '';
          durationDisplay = `<div class="song-duration ${durationClass}" title="${durationSeconds} segundos"><i class="fas fa-clock"></i> ${formattedDuration}${durationSeconds > MAX_DURATION_SECONDS ? ' (NO PERMITIDA)' : ''}</div>`;
        }
        html += `<div class="song-item" onclick="suggestSong('${videoId}', '${title.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', '${artist.replace(/'/g, "\\'")}', this, ${durationSeconds})"><div class="song-info"><div class="song-title">${displayTitle}</div><div class="song-artist">${artist}</div>${durationDisplay}</div><button class="add-btn" ${durationSeconds > MAX_DURATION_SECONDS ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}><i class="fas fa-plus"></i> ${durationSeconds > MAX_DURATION_SECONDS ? 'DEMASIADO LARGA' : 'AGREGAR'}</button></div>`;
      });
      container.innerHTML = html;
    }

    async function suggestSong(videoId, title, artist, element, durationSeconds = 0) {
      playSound('click-sound');
      if (durationSeconds > MAX_DURATION_SECONDS) {
        const durationFormatted = formatDuration(durationSeconds);
        const maxFormatted = formatDuration(MAX_DURATION_SECONDS);
        showMessage(`‚ùå Esta canci√≥n dura ${durationFormatted} (l√≠mite: ${maxFormatted}). No se puede agregar.`, 'error');
        element.style.animation = 'shake 0.5s';
        element.style.backgroundColor = 'rgba(255, 107, 107, 0.15)';
        element.style.borderLeftColor = 'var(--danger)';
        setTimeout(() => element.style.animation = '', 500);
        return;
      }
      if (!currentUser) {
        showMessage('‚ö†Ô∏è Necesitas ingresar tu nombre primero', 'warning');
        showNicknameSection();
        return;
      }
      if (!canAddSong()) {
        const waitTime = Math.ceil((COOLDOWN_MS - (Date.now() - parseInt(localStorage.getItem('moyofy_last_add')))) / 60000);
        showMessage(`‚è≥ Espera ${waitTime} minuto(s) antes de agregar otra canci√≥n.`, 'warning');
        return;
      }
      try {
        const coords = await requestLocation();
        if (!isUserNearBar(coords.latitude, coords.longitude)) {
          showMessage('üìç ¬°Solo desde Rafa\'s Bar! Ac√©rcate al local para agregar canciones.', 'warning');
          return;
        }
      } catch (error) {
        if (error.code === 1) {
          showMessage('üìç Permiso de ubicaci√≥n requerido. Permite el acceso para agregar canciones.', 'error');
        } else {
          showMessage('üìç Error al obtener tu ubicaci√≥n. ¬øEst√°s en el bar?', 'error');
        }
        return;
      }
      if (requiresAuth) {
        showMessage('üîê Necesitas autenticarte con YouTube para agregar canciones', 'error');
        showAuthRequiredMessage();
        return;
      }
      try {
        const button = element.querySelector('.add-btn');
        const rect = button.getBoundingClientRect();
        const x = rect.left + rect.width / 2;
        const y = rect.top + rect.height / 2;
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SUGERIDO...';
        const response = await fetch(`${API_BASE}/suggest-song`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId: videoId, title: title, userId: currentUser.id })
        });
        const data = await response.json();
        if (data.ok) {
          element.classList.add('bounce');
          element.style.backgroundColor = 'rgba(0, 255, 170, 0.15)';
          element.style.borderLeftColor = 'var(--success)';
          currentUser.points = (currentUser.points || 100) + GAMIFICATION.pointsPerSong;
          currentUser.songsAdded = (currentUser.songsAdded || 0) + 1;
          currentUser.streak = (currentUser.streak || 0) + 1;
          setLastAddTime();
          localStorage.setItem('moyofy_user', JSON.stringify(currentUser));
          updateUserProfile();
          const shortTitle = title.length > 40 ? title.substring(0, 40) + '...' : title;
          showMessage(`‚úÖ ¬°"${shortTitle}" sugerida y agregada a la playlist! +${GAMIFICATION.pointsPerSong} MOYOS`, 'success');
          playSound('success-sound');
          createEpicConfettiExplosion(x, y, 120);
          createPointsAnimation(x, y, GAMIFICATION.pointsPerSong);
          setTimeout(() => {
            document.getElementById('results-container').innerHTML = `<div class="message success"><i class="fas fa-check-circle"></i> ¬°Canci√≥n agregada exitosamente!<br><small>Busca m√°s canciones para agregar</small><p style="margin-top: 10px; font-size: 0.9rem;"><i class="fas fa-clock"></i> Recuerda: L√≠mite de ${MAX_DURATION_MINUTES} minutos por canci√≥n</p></div>`;
            document.getElementById('song-search').value = '';
            document.getElementById('song-search').focus();
          }, 2000);
        } else {
          if (data.requiresAuth) {
            requiresAuth = true;
            showAuthRequiredMessage();
            throw new Error('üîê Necesitas autenticarte con YouTube para agregar canciones');
          }
          if (data.error && data.error.includes('dura m√°s de 7 minutos')) {
            showMessage(`‚è±Ô∏è ${data.error}`, 'error');
            element.querySelector('.add-btn').innerHTML = '<i class="fas fa-clock"></i> DEMASIADO LARGA';
            element.querySelector('.add-btn').disabled = true;
            element.querySelector('.add-btn').style.opacity = '0.5';
            element.querySelector('.add-btn').style.cursor = 'not-allowed';
            element.style.animation = 'shake 0.5s';
            element.style.backgroundColor = 'rgba(255, 107, 107, 0.15)';
            element.style.borderLeftColor = 'var(--danger)';
            setTimeout(() => element.style.animation = '', 500);
          } else {
            throw new Error(data.error || 'Error al sugerir canci√≥n');
          }
        }
      } catch (error) {
        console.error('Error al sugerir canci√≥n:', error);
        if (!error.message.includes('dura m√°s de 7 minutos')) {
          showMessage(`‚ùå Error: ${error.message}`, 'error');
        }
      } finally {
        const button = element.querySelector('.add-btn');
        if (button && !button.disabled) {
          button.disabled = false;
          button.innerHTML = '<i class="fas fa-plus"></i> AGREGAR';
          element.classList.remove('bounce');
        }
      }
    }

    function isUserNearBar(userLat, userLng) {
      const toRadians = (degrees) => degrees * Math.PI / 180;
      const R = 6371000;
      const barLat = BAR_LOCATION.lat;
      const barLng = BAR_LOCATION.lng;
      const dLat = toRadians(userLat - barLat);
      const dLng = toRadians(userLng - barLng);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRadians(barLat)) * Math.cos(toRadians(userLat)) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const distance = R * c;
      return distance <= RADIUS_METERS;
    }

    function requestLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) reject(new Error('Geolocalizaci√≥n no soportada.'));
        navigator.geolocation.getCurrentPosition(
          (position) => resolve(position.coords),
          (error) => reject(error)
        );
      });
    }

    function canAddSong() {
      const lastAddTime = localStorage.getItem('moyofy_last_add');
      if (!lastAddTime) return true;
      const now = Date.now();
      return (now - parseInt(lastAddTime)) >= COOLDOWN_MS;
    }

    function setLastAddTime() {
      localStorage.setItem('moyofy_last_add', Date.now().toString());
    }

    function showMessage(text, type = 'info') {
      const container = document.getElementById('message-container');
      let icon = 'info-circle';
      if (type === 'success') icon = 'check-circle';
      else if (type === 'error') icon = 'exclamation-circle';
      else if (type === 'warning') icon = 'exclamation-triangle';
      container.innerHTML = `<div class="message ${type} bounce"><i class="fas fa-${icon}"></i>${text}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }

    function showAuthRequiredMessage() {
      document.getElementById('auth-required-message').style.display = 'block';
    }

    function redirectToAuth() {
      window.location.href = `${API_BASE}/auth`;
    }

    function changeUsername() {
      playSound('click-sound');
      if (confirm('¬øEst√°s seguro de que quieres cambiar tu apodo? Perder√°s tu progreso actual.')) {
        localStorage.removeItem('moyofy_user');
        currentUser = null;
        lastLevel = 1;
        showNicknameSection();
        showMessage('‚úèÔ∏è Ingresa tu nuevo apodo para continuar', 'info');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ MOYOFY PREMIUM v2 cargado - L√≠mite de 7 minutos activado');
      const savedUser = localStorage.getItem('moyofy_user');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        lastLevel = calculateLevel(currentUser.points || 100).level;
      }
    });
  </script>
</body>
</html>